name: Maintenance

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      dependency_check:
        description: 'Run dependency update check'
        required: false
        default: 'true'
        type: boolean

jobs:
  # Update frontend dependencies
  update-frontend-deps:
    name: Update Frontend Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dependency_check == 'true')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9.0.0

    - name: Update dependencies
      id: update
      run: |
        pnpm install --frozen-lockfile

        # Check for updates
        OUTDATED=$(pnpm outdated --json || echo '{}')
        echo "outdated=$OUTDATED" >> $GITHUB_OUTPUT

        # Update dependencies
        pnpm update --latest

        # Generate updated lockfile
        pnpm install

        # Check if lockfile changed
        if git diff --quiet pnpm-lock.yaml; then
          echo "updated=false" >> $GITHUB_OUTPUT
        else
          echo "updated=true" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.update.outputs.updated == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update frontend dependencies'
        title: 'chore: update frontend dependencies'
        body: |
          ## Frontend Dependency Updates

          This PR updates frontend dependencies to their latest versions.

          ### Changes
          - Updated pnpm-lock.yaml with latest package versions
          - All dependency updates tested in CI

          ### Verification
          - [x] Dependencies installed successfully
          - [x] Type checks pass
          - [x] Build completes successfully

          Please review the changes and ensure compatibility before merging.
        branch: chore/update-frontend-deps
        delete-branch: true

  # Update Rust dependencies
  update-rust-deps:
    name: Update Rust Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dependency_check == 'true')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-edit
      run: cargo install cargo-edit

    - name: Update dependencies
      id: update
      run: |
        cd src-tauri

        # Update workspace dependencies
        cargo upgrade --workspace

        # Check if Cargo.lock changed
        if git diff --quiet Cargo.lock; then
          echo "updated=false" >> $GITHUB_OUTPUT
        else
          echo "updated=true" >> $GITHUB_OUTPUT
        fi

    - name: Run tests
      if: steps.update.outputs.updated == 'true'
      run: |
        cd src-tauri
        cargo test --verbose

    - name: Create Pull Request
      if: steps.update.outputs.updated == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update Rust dependencies'
        title: 'chore: update Rust dependencies'
        body: |
          ## Rust Dependency Updates

          This PR updates Rust dependencies to their latest compatible versions.

          ### Changes
          - Updated Cargo.lock with latest dependency versions
          - Dependencies updated using `cargo upgrade`

          ### Verification
          - [x] Dependencies compiled successfully
          - [x] All tests pass
          - [x] Clippy checks pass

          Please review the changes and ensure compatibility before merging.
        branch: chore/update-rust-deps
        delete-branch: true

  # Security audit and report
  security-audit:
    name: Security Audit Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9.0.0

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Generate security report
      id: security
      run: |
        # Frontend audit
        FRONTEND_AUDIT=$(pnpm audit --json 2>/dev/null || echo '{"vulnerabilities":{}}')

        # Install cargo-audit
        cargo install cargo-audit

        # Backend audit
        BACKEND_AUDIT=$(cd src-tauri && cargo audit --json 2>/dev/null || echo '{"vulnerabilities":[]}')

        # Create report
        cat > security-report.md << 'EOF'
        # Security Audit Report

        Generated on: $(date)

        ## Frontend Dependencies

        \`\`\`json
        $FRONTEND_AUDIT
        \`\`\`

        ## Backend Dependencies

        \`\`\`json
        $BACKEND_AUDIT
        \`\`\`

        ## Summary

        Please review the audit reports above for any security vulnerabilities.
        EOF

        echo "report_created=true" >> $GITHUB_OUTPUT

    - name: Create Issue for Security Issues
      if: steps.security.outputs.report_created == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('security-report.md', 'utf8');

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Security Audit Report - ${new Date().toISOString().split('T')[0]}`,
            body: report,
            labels: ['security', 'maintenance']
          });

  # Cleanup old artifacts
  cleanup-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
    - name: Delete old artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listRepoArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });

          // Delete artifacts older than 30 days
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

          for (const artifact of artifacts.data.artifacts) {
            const createdDate = new Date(artifact.created_at);
            if (createdDate < thirtyDaysAgo) {
              console.log(`Deleting artifact: ${artifact.name} (${artifact.id})`);
              try {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
              } catch (error) {
                console.log(`Failed to delete artifact ${artifact.name}: ${error.message}`);
              }
            }
          }