name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Create GitHub Release
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}

    steps:
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: VirtualMeet ${{ github.ref_name }}
        draft: false
        prerelease: false
        body: |
          ## What's Changed

          See [CHANGELOG.md](CHANGELOG.md) for detailed changes.

          ## Download

          - Windows: VirtualMeet_${{ github.ref_name }}_x64-setup.exe

          ## Installation

          1. Download the appropriate installer for your platform
          2. Run the installer
          3. Launch VirtualMeet from the Start menu or desktop shortcut

          ## Verification

          All binaries are signed and verified before release.

  # Build for Windows
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: create-release

    strategy:
      matrix:
        platform:
          - x86_64-pc-windows-msvc
        include:
          - platform: x86_64-pc-windows-msvc
            arch: x64
            ext: .exe

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9.0.0

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.platform }}

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-${{ matrix.platform }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.platform }}-cargo-

    - name: Install system dependencies
      run: |
        choco install -y llvm
        echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH

    - name: Install frontend dependencies
      run: pnpm install --frozen-lockfile

    - name: Build Tauri app
      run: pnpm tauri:build
      env:
        TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

    - name: Package artifacts
      run: |
        mkdir dist
        cp src-tauri/target/release/bundle/nsis/VirtualMeet_*${{ matrix.ext }} dist/
        cp src-tauri/target/release/VirtualMeet${{ matrix.ext }} dist/

        # Create portable version
        cd dist
        mkdir portable
        copy VirtualMeet${{ matrix.ext }} portable/
        copy ..\..\src-tauri\icons\*.* portable\ 2>nul || echo "No icons found"

        # Create zip for portable version
        7z a -tzip VirtualMeet-${{ github.ref_name }}-${{ matrix.arch }}-portable.zip portable\

    - name: Upload Release Asset (Installer)
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./dist/VirtualMeet_${{ github.ref_name }}_${{ matrix.arch }}-setup${{ matrix.ext }}
        asset_name: VirtualMeet_${{ github.ref_name }}_${{ matrix.arch }}-setup${{ matrix.ext }}
        asset_content_type: application/octet-stream

    - name: Upload Release Asset (Portable)
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./dist/VirtualMeet-${{ github.ref_name }}-${{ matrix.arch }}-portable.zip
        asset_name: VirtualMeet-${{ github.ref_name }}-${{ matrix.arch }}-portable.zip
        asset_content_type: application/zip

  # Update release notes with checksums
  update-release-notes:
    name: Update Release Notes
    runs-on: ubuntu-latest
    needs: [create-release, build-windows]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: VirtualMeet-*
        merge-multiple: true

    - name: Generate checksums
      run: |
        echo "## Checksums" >> checksums.md
        echo "" >> checksums.md
        echo "Use these SHA256 checksums to verify your downloads:" >> checksums.md
        echo "" >> checksums.md

        for file in VirtualMeet_*; do
          if [ -f "$file" ]; then
            checksum=$(sha256sum "$file" | awk '{print $1}')
            echo "### $file" >> checksums.md
            echo "\`\`\`" >> checksums.md
            echo "$checksum" >> checksums.md
            echo "\`\`\`" >> checksums.md
            echo "" >> checksums.md
          fi
        done

    - name: Update release description
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const checksums = fs.readFileSync('checksums.md', 'utf8');

          const { data: release } = await github.rest.repos.getRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: ${{ needs.create-release.outputs.release_id }}
          });

          const updatedBody = release.body + '\n\n' + checksums;

          await github.rest.repos.updateRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: ${{ needs.create-release.outputs.release_id }},
            body: updatedBody
          });

  # Notify on release completion
  notify:
    name: Notify Release Complete
    runs-on: ubuntu-latest
    needs: [create-release, build-windows, update-release-notes]
    if: always()

    steps:
    - name: Notify success
      if: ${{ needs.create-release.result == 'success' && needs.build-windows.result == 'success' && needs.update-release-notes.result == 'success' }}
      run: |
        echo "üéâ Release ${{ github.ref_name }} completed successfully!"
        echo "üì¶ Download from: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"

    - name: Notify failure
      if: ${{ needs.create-release.result == 'failure' || needs.build-windows.result == 'failure' || needs.update-release-notes.result == 'failure' }}
      run: |
        echo "‚ùå Release ${{ github.ref_name }} failed!"
        exit 1